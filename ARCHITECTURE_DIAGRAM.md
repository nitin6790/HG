# System Architecture Diagram - After Fixes

## Complete Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          REACT NATIVE MOBILE APP                            â”‚
â”‚                         (Expo - Port 8081)                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                               â”‚
â”‚  User Action: Stock In "Single Segment" Qty 50                              â”‚
â”‚     â†“                                                                        â”‚
â”‚  API Client sends POST /api/items                                           â”‚
â”‚  {                                                                          â”‚
â”‚    name: "Single Segment",                                                 â”‚
â”‚    categoryId: "63f7...",                                                   â”‚
â”‚    warehouseId: "63f8...",                                                  â”‚
â”‚    quantity: 50                                                             â”‚
â”‚  }                                                                          â”‚
â”‚                                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚ HTTPS
                               â”‚ https://hsgi-backend.onrender.com/api/items
                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    EXPRESS SERVER (Render.com)                              â”‚
â”‚                      Node.js + Express 4.18                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                               â”‚
â”‚  POST /api/items route handler (items.js)                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 1. VALIDATE INPUT                                                    â”‚   â”‚
â”‚  â”‚    âœ… name, categoryId, warehouseId required                         â”‚   â”‚
â”‚  â”‚    âœ… quantity > 0                                                   â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚ 2. CHECK IF ITEM EXISTS (UPSERT LOGIC) â† NEW FIX!                   â”‚   â”‚
â”‚  â”‚    let item = await Item.findOne({                                  â”‚   â”‚
â”‚  â”‚      name: "Single Segment",                                        â”‚   â”‚
â”‚  â”‚      warehouseId: "63f8..."                                         â”‚   â”‚
â”‚  â”‚    })                                                                â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚    IF item FOUND:                                                   â”‚   â”‚
â”‚  â”‚      âœ… item.quantity += 50      (INCREMENT, DON'T CREATE)          â”‚   â”‚
â”‚  â”‚      âœ… await item.save()                                           â”‚   â”‚
â”‚  â”‚      âœ… NO E11000 ERROR! âœ¨                                         â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚    IF item NOT FOUND:                                               â”‚   â”‚
â”‚  â”‚      âœ… await Item.create({...})  (CREATE NEW)                      â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚ 3. CREATE STOCK TRANSACTION RECORD â† NEW FEATURE!                   â”‚   â”‚
â”‚  â”‚    await StockTransaction.create({                                  â”‚   â”‚
â”‚  â”‚      type: "IN",                                                    â”‚   â”‚
â”‚  â”‚      item: item._id,                                                â”‚   â”‚
â”‚  â”‚      warehouse: "63f8...",                                          â”‚   â”‚
â”‚  â”‚      quantity: 50,                                                  â”‚   â”‚
â”‚  â”‚      date: Date.now(),                                              â”‚   â”‚
â”‚  â”‚      notes: ""                                                      â”‚   â”‚
â”‚  â”‚    })                                                                â”‚   â”‚
â”‚  â”‚    âœ… AUDIT TRAIL CREATED                                           â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚ 4. POPULATE REFERENCES (SAFE PATTERN) â† NEW FIX!                    â”‚   â”‚
â”‚  â”‚    const populatedItem = await Item.findById(item._id)              â”‚   â”‚
â”‚  â”‚      .populate("categoryId")                                        â”‚   â”‚
â”‚  â”‚      .populate("warehouseId")                                       â”‚   â”‚
â”‚  â”‚    âœ… SAFE POPULATE PATTERN (no chaining error)                     â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚ 5. RETURN RESPONSE                                                  â”‚   â”‚
â”‚  â”‚    res.status(201).json(populatedItem)                              â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚ 6. HANDLE ERRORS                                                    â”‚   â”‚
â”‚  â”‚    Try-catch with detailed messages                                 â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚                              â”‚
                           â”‚ Mongoose                     â”‚ Mongoose
                           â–¼                              â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   MongoDB Items Collection   â”‚   â”‚ MongoDB Transactions Coll.   â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚                              â”‚   â”‚                              â”‚
        â”‚ BEFORE (First Call):         â”‚   â”‚ BEFORE (First Call):         â”‚
        â”‚ {                            â”‚   â”‚ {                            â”‚
        â”‚   _id: ObjectId(...),        â”‚   â”‚   _id: ObjectId(...),        â”‚
        â”‚   name: "S.S",               â”‚   â”‚   type: "IN",                â”‚
        â”‚   quantity: 50 â† NEW         â”‚   â”‚   quantity: 50,              â”‚
        â”‚   categoryId: Ref,           â”‚   â”‚   item: ObjectId(...),       â”‚
        â”‚   warehouseId: Ref,          â”‚   â”‚   warehouse: ObjectId(...),  â”‚
        â”‚   createdAt, updatedAt       â”‚   â”‚   date: Date,                â”‚
        â”‚ }                            â”‚   â”‚   createdAt, updatedAt       â”‚
        â”‚                              â”‚   â”‚ }                            â”‚
        â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
        â”‚                              â”‚   â”‚                              â”‚
        â”‚ AFTER (Second Call):         â”‚   â”‚ AFTER (Second Call):         â”‚
        â”‚ {                            â”‚   â”‚ [{                           â”‚
        â”‚   _id: ObjectId(...) â† SAME  â”‚   â”‚   _id: ObjectId(...),        â”‚
        â”‚   name: "S.S",               â”‚   â”‚   type: "IN",                â”‚
        â”‚   quantity: 100 â† UPDATED!   â”‚   â”‚   quantity: 50,              â”‚
        â”‚   categoryId: Ref,           â”‚   â”‚   item: ObjectId(...),       â”‚
        â”‚   warehouseId: Ref,          â”‚   â”‚   warehouse: ObjectId(...),  â”‚
        â”‚   createdAt, updatedAt â†‘     â”‚   â”‚   date: Date,                â”‚
        â”‚                              â”‚   â”‚   createdAt, updatedAt       â”‚
        â”‚ }                            â”‚   â”‚ }, {                         â”‚
        â”‚ âœ… NO DUPLICATE!             â”‚   â”‚   _id: ObjectId(...),        â”‚
        â”‚ âœ… ONE DOCUMENT              â”‚   â”‚   type: "IN",                â”‚
        â”‚ âœ… CORRECT QUANTITY          â”‚   â”‚   quantity: 50 â† SECOND!     â”‚
        â”‚                              â”‚   â”‚   item: ObjectId(...),       â”‚
        â”‚                              â”‚   â”‚   warehouse: ObjectId(...),  â”‚
        â”‚                              â”‚   â”‚   date: Date,                â”‚
        â”‚                              â”‚   â”‚   createdAt, updatedAt       â”‚
        â”‚                              â”‚   â”‚ }]                           â”‚
        â”‚                              â”‚   â”‚ âœ… FULL HISTORY               â”‚
        â”‚                              â”‚   â”‚ âœ… TWO TRANSACTIONS           â”‚
        â”‚                              â”‚   â”‚ âœ… AUDIT TRAIL                â”‚
        â”‚                              â”‚   â”‚                              â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚                              â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚              Backend Response (JSON)                         â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚ {                                                            â”‚
        â”‚   "_id": "63f7a1b2c3d4e5f6g7h8i9j2",                        â”‚
        â”‚   "name": "Single Segment",                                 â”‚
        â”‚   "quantity": 100,             â† Updated                   â”‚
        â”‚   "categoryId": {              â† POPULATED!                â”‚
        â”‚     "_id": "63f7a1b2c3d4e5f6g7h8i9j0",                      â”‚
        â”‚     "name": "Single Segment Category"                      â”‚
        â”‚   },                                                        â”‚
        â”‚   "warehouseId": {             â† POPULATED!                â”‚
        â”‚     "_id": "63f7a1b2c3d4e5f6g7h8i9j1",                      â”‚
        â”‚     "name": "Warehouse 1"                                  â”‚
        â”‚   },                                                        â”‚
        â”‚   "inDates": ["2025-01-15T04:00Z"],                         â”‚
        â”‚   "inQuantities": [50],                                    â”‚
        â”‚   "createdAt": "2025-01-15T04:00:00Z",                      â”‚
        â”‚   "updatedAt": "2025-01-15T04:00:00Z"                       â”‚
        â”‚ }                                                           â”‚
        â”‚                                                             â”‚
        â”‚ âœ… All fields populated                                      â”‚
        â”‚ âœ… No errors                                                 â”‚
        â”‚ âœ… Complete item data returned                               â”‚
        â”‚                                                             â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚ HTTPS
                                      â”‚
                                      â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚              MOBILE APP (React Native)                       â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚                                                              â”‚
        â”‚  Axios intercepts response                                  â”‚
        â”‚  Context updates with new item                             â”‚
        â”‚  FlatList re-renders                                       â”‚
        â”‚                                                              â”‚
        â”‚  UI Shows:                                                  â”‚
        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
        â”‚  â”‚ Single Segment                                     â”‚    â”‚
        â”‚  â”‚ Qty: 100                                           â”‚    â”‚
        â”‚  â”‚ Category: Single Segment Category                 â”‚    â”‚
        â”‚  â”‚ Warehouse: Warehouse 1                            â”‚    â”‚
        â”‚  â”‚                                                    â”‚    â”‚
        â”‚  â”‚ [Stock In] [Stock Out] [Delete]                   â”‚    â”‚
        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
        â”‚                                                              â”‚
        â”‚ âœ… NO ERROR POPUP                                            â”‚
        â”‚ âœ… ITEM DISPLAYED CORRECTLY                                  â”‚
        â”‚ âœ… QUANTITY SHOWS 100                                        â”‚
        â”‚ âœ… USER HAPPY! ğŸ‰                                            â”‚
        â”‚                                                              â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Before & After Comparison

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              BEFORE FIX                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                               â”‚
â”‚  First Stock In: qty 50 â†’ SUCCESS âœ…                                         â”‚
â”‚  {                                                                          â”‚
â”‚    _id: "001",                                                              â”‚
â”‚    name: "Single Segment",                                                 â”‚
â”‚    quantity: 50                                                             â”‚
â”‚  }                                                                          â”‚
â”‚                                                                               â”‚
â”‚  Second Stock In: qty 50 â†’ ERROR âŒ                                          â”‚
â”‚  E11000 duplicate key error                                                 â”‚
â”‚  collection: hsgi-db.items index: name_1_warehouse_1                        â”‚
â”‚  dup key: { name: "Single Segment", warehouse: ... }                        â”‚
â”‚                                                                               â”‚
â”‚  Database State:                                                             â”‚
â”‚  Items: [                                                                    â”‚
â”‚    { _id: "001", name: "S.S", quantity: 50 }                                â”‚
â”‚  ]                                                                          â”‚
â”‚  STUCK! Can't add more stock to existing item!                              â”‚
â”‚                                                                               â”‚
â”‚  Also:                                                                      â”‚
â”‚  - Populate chaining broke (method error)                                   â”‚
â”‚  - No transaction history                                                   â”‚
â”‚  - No audit trail                                                           â”‚
â”‚                                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              AFTER FIX                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                               â”‚
â”‚  First Stock In: qty 50 â†’ SUCCESS âœ…                                         â”‚
â”‚  {                                                                          â”‚
â”‚    _id: "001",                                                              â”‚
â”‚    name: "Single Segment",                                                 â”‚
â”‚    quantity: 50                                                             â”‚
â”‚  }                                                                          â”‚
â”‚                                                                               â”‚
â”‚  Second Stock In: qty 50 â†’ SUCCESS âœ… (UPDATED, NOT CREATED)                â”‚
â”‚  {                                                                          â”‚
â”‚    _id: "001" â† SAME ID                                                    â”‚
â”‚    name: "Single Segment",                                                 â”‚
â”‚    quantity: 100 â† INCREMENTED                                             â”‚
â”‚  }                                                                          â”‚
â”‚                                                                               â”‚
â”‚  Third Stock In: qty 25 â†’ SUCCESS âœ…                                         â”‚
â”‚  {                                                                          â”‚
â”‚    _id: "001" â† STILL SAME ID                                              â”‚
â”‚    name: "Single Segment",                                                 â”‚
â”‚    quantity: 125 â† INCREMENTED AGAIN                                       â”‚
â”‚  }                                                                          â”‚
â”‚                                                                               â”‚
â”‚  Database State:                                                             â”‚
â”‚  Items: [                                                                    â”‚
â”‚    { _id: "001", name: "S.S", quantity: 125, qty: [50,50,25] }             â”‚
â”‚  ] â† ONE ITEM, CORRECT QUANTITY                                             â”‚
â”‚                                                                               â”‚
â”‚  Transactions: [                                                             â”‚
â”‚    { type: "IN", qty: 50, date: "2025-01-15T04:00Z" },                      â”‚
â”‚    { type: "IN", qty: 50, date: "2025-01-15T05:00Z" },                      â”‚
â”‚    { type: "IN", qty: 25, date: "2025-01-15T06:00Z" }                       â”‚
â”‚  ] â† FULL AUDIT TRAIL                                                       â”‚
â”‚                                                                               â”‚
â”‚  Features:                                                                  â”‚
â”‚  âœ… No duplicate key errors                                                  â”‚
â”‚  âœ… Safe populate chaining                                                   â”‚
â”‚  âœ… Full audit trail                                                         â”‚
â”‚  âœ… Can query transaction history                                            â”‚
â”‚  âœ… Complete compliance tracking                                             â”‚
â”‚                                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Component Interaction Map

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Mobile App    â”‚
â”‚ (React Native)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ Uses
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    API Client            â”‚
â”‚  (src/api/client.js)     â”‚
â”‚                          â”‚
â”‚  Methods:                â”‚
â”‚  - itemAPI.create()      â”‚ â† Uses POST /api/items
â”‚  - itemAPI.stockIn()     â”‚ â† Uses POST /api/items/:id/stock-in
â”‚  - itemAPI.stockOut()    â”‚ â† Uses POST /api/items/:id/stock-out
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ HTTP/REST
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Express Server                   â”‚
â”‚   (backend/routes/items.js)         â”‚
â”‚                                      â”‚
â”‚   POST /api/items                    â”‚
â”‚   â”œâ”€ Validate input                  â”‚
â”‚   â”œâ”€ Check if item exists (UPSERT)   â”‚
â”‚   â”œâ”€ Create StockTransaction         â”‚
â”‚   â”œâ”€ Safe populate                   â”‚
â”‚   â””â”€ Return item                     â”‚
â”‚                                      â”‚
â”‚   POST /api/items/:id/stock-in       â”‚
â”‚   â”œâ”€ Validate quantity               â”‚
â”‚   â”œâ”€ Increment qty                   â”‚
â”‚   â”œâ”€ Create StockTransaction (IN)    â”‚
â”‚   â””â”€ Return item                     â”‚
â”‚                                      â”‚
â”‚   POST /api/items/:id/stock-out      â”‚
â”‚   â”œâ”€ Validate quantity               â”‚
â”‚   â”œâ”€ Check if sufficient stock       â”‚
â”‚   â”œâ”€ Decrement qty                   â”‚
â”‚   â”œâ”€ Create StockTransaction (OUT)   â”‚
â”‚   â””â”€ Return item                     â”‚
â”‚                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                  â”‚
    Mongoose             Mongoose
         â”‚                  â”‚
         â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Item Model      â”‚  â”‚ StockTransaction     â”‚
â”‚                  â”‚  â”‚ Model                â”‚
â”‚  name (String)   â”‚  â”‚                      â”‚
â”‚  quantity        â”‚  â”‚ type (IN/OUT)        â”‚
â”‚  categoryId      â”‚  â”‚ item (Ref)           â”‚
â”‚  warehouseId     â”‚  â”‚ warehouse (Ref)      â”‚
â”‚  inDates         â”‚  â”‚ quantity             â”‚
â”‚  inQuantities    â”‚  â”‚ date                 â”‚
â”‚  outDates        â”‚  â”‚ notes                â”‚
â”‚  outQuantities   â”‚  â”‚                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                        â”‚
     MongoDB                  MongoDB
         â”‚                        â”‚
         â–¼                        â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Items Table â”‚          â”‚ Transactions â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚ Table        â”‚
                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Deployment Architecture

```
                    GitHub Repository
                    (nitin6790/HG)
                           â”‚
                           â”‚ push
                           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   GitHub    â”‚
                    â”‚  Webhook    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â”‚ trigger
                           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Render.com     â”‚
                    â”‚  (Free Tier)     â”‚
                    â”‚                  â”‚
                    â”‚ Backend URL:     â”‚
                    â”‚ https://hsgi-    â”‚
                    â”‚ backend.         â”‚
                    â”‚ onrender.com/    â”‚
                    â”‚ api/...          â”‚
                    â”‚                  â”‚
                    â”‚ Auto-deploys on  â”‚
                    â”‚ push to master   â”‚
                    â”‚                  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                            â”‚
                    â–¼                            â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ Node.js 18   â”‚          â”‚  MongoDB Atlas   â”‚
            â”‚ Express 4.18 â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  (Cloud DB)      â”‚
            â”‚ Mongoose 8.0 â”‚          â”‚                  â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚  hsgi-db         â”‚
                                      â”‚  - items         â”‚
                                      â”‚  - categories    â”‚
                                      â”‚  - warehouses    â”‚
                                      â”‚  - transactions  â”‚
                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                         Connected to:
                    
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Mobile App (Expo)   â”‚
                    â”‚  React Native 0.81.5 â”‚
                    â”‚                      â”‚
                    â”‚  API Base URL:       â”‚
                    â”‚  https://hsgi-       â”‚
                    â”‚  backend.onrender.   â”‚
                    â”‚  com/api             â”‚
                    â”‚                      â”‚
                    â”‚  Makes REST calls to â”‚
                    â”‚  backend endpoints   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Summary

All three issues fixed with clean, maintainable code:

1. **E11000 Error** â†’ Upsert logic checks before creating
2. **Populate Error** â†’ Safe query pattern used throughout
3. **No Tracking** â†’ StockTransaction collection logs everything

**Result:** Robust, traceable, error-free inventory backend! ğŸš€
